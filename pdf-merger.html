<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Merger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a1a2e;
            color: #f8f9fa;
        }

        body.dark-mode .card {
            background-color: #16213e;
            border-color: #0f3460;
        }

        body.dark-mode .card-header {
            border-bottom-color: #0f3460;
        }

        body.dark-mode .form-control, 
        body.dark-mode .form-select,
        body.dark-mode .input-group-text {
            background-color: #0f3460;
            border-color: #0f3460;
            color: #f8f9fa;
        }

        body.dark-mode .drop-zone {
            background-color: #0f3460;
            border-color: #0f3460;
        }

        body.dark-mode .thumbnail-container {
            background-color: #0f3460;
            border-color: #0f3460;
        }

        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .drop-zone.active {
            border-color: var(--primary-color);
            background-color: rgba(78, 115, 223, 0.05);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .preview-container {
            min-height: 300px;
            position: relative;
        }

        #pdf-thumbnails {
            display: none;
        }

        .thumbnail-container {
            position: relative;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        .thumbnail-canvas {
            width: 100%;
            height: auto;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .page-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .page-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .ad-space {
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .sortable-ghost {
            opacity: 0.5;
            background: #c8ebfb;
        }

        .admin-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
        }

        #large-preview-canvas {
            max-width: 100%;
            max-height: 70vh;
            border: 1px solid #ddd;
        }

        @media (max-width: 768px) {
            .page-controls .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <header class="text-center mb-4">
            <h1 class="display-5"><i class="fas fa-file-pdf text-danger me-2"></i>Advanced PDF Merger</h1>
            <p class="text-muted">Merge, rearrange, and optimize your PDF documents</p>
        </header>

        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-9">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload PDF Files</h5>
                        <span id="file-count" class="badge bg-light text-dark">0 files</span>
                    </div>
                    <div class="card-body">
                        <div id="drop-area" class="drop-zone p-4 text-center">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drag & Drop PDF files here</h5>
                            <p class="text-muted">or</p>
                            <button id="file-input-btn" class="btn btn-primary">
                                <i class="fas fa-folder-open me-2"></i>Browse Files
                            </button>
                            <input type="file" id="file-input" accept=".pdf" multiple style="display: none;">
                        </div>
                        <div id="file-list" class="mt-3"></div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>PDF Preview & Editor</h5>
                        <span id="page-count" class="badge bg-light text-dark">0 pages</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6 mb-2 mb-md-0">
                                <div class="input-group">
                                    <span class="input-group-text">Filename</span>
                                    <input type="text" id="output-filename" class="form-control" value="merged_document.pdf">
                                    <span class="input-group-text">.pdf</span>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2 mb-md-0">
                                <select id="page-size" class="form-select">
                                    <option value="A4">A4 Size</option>
                                    <option value="Letter">Letter Size</option>
                                    <option value="Legal">Legal Size</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button id="merge-btn" class="btn btn-success w-100" disabled>
                                    <i class="fas fa-random me-2"></i>Merge PDFs
                                </button>
                            </div>
                        </div>
                        <div id="pdf-preview-container" class="preview-container">
                            <div id="no-files-message" class="text-center py-5">
                                <i class="fas fa-file-pdf fa-4x text-muted mb-3"></i>
                                <h5>No PDF files uploaded yet</h5>
                                <p class="text-muted">Upload PDF files to preview and edit them</p>
                            </div>
                            <div id="pdf-thumbnails" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar with Ads and Settings -->
            <div class="col-lg-3">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-ad me-2"></i>Advertisement</h5>
                    </div>
                    <div class="card-body text-center">
                        <!-- AdSense Ad Unit -->
                        <div id="ad-container" class="ad-space">
                            <div id="adsense-ad" class="p-3 w-100">
                                <p class="text-muted mb-0">Advertisement will appear here</p>
                                <small class="text-muted">AdSense not configured</small>
                            </div>
                        </div>
                        
                        <!-- AdSense Configuration for Admin -->
                        <div class="mt-4" id="adsense-config" style="display: none;">
                            <h6 class="mb-3">AdSense Configuration</h6>
                            <div class="mb-3">
                                <label for="adsense-publisher-id" class="form-label">Publisher ID</label>
                                <input type="text" class="form-control mb-2" id="adsense-publisher-id" placeholder="ca-pub-xxxxxxxxxxxxx">
                                <label for="adsense-unit-id" class="form-label">Ad Unit ID</label>
                                <input type="text" class="form-control" id="adsense-unit-id" placeholder="xxxxxxxxxx">
                            </div>
                            <button id="save-adsense" class="btn btn-sm btn-info me-2">Save Settings</button>
                            <button id="test-adsense" class="btn btn-sm btn-outline-info">Test Ad</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="dark-mode-switch">
                            <label class="form-check-label" for="dark-mode-switch">Dark Mode</label>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button id="admin-toggle" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-unlock-alt me-2"></i>Admin Mode
                            </button>
                            <button id="clear-all" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash-alt me-2"></i>Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center py-3 text-muted small">
            <p>Advanced PDF Merger &copy; <span id="current-year"></span> | <a href="#" class="text-decoration-none">Privacy Policy</a></p>
        </footer>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">PDF Page Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <canvas id="large-preview-canvas"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal fade" id="downloadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Merge Complete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                    <h5>Your PDF is ready!</h5>
                    <p class="text-muted">Click the button below to download your merged document</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button id="download-btn" class="btn btn-success btn-lg">
                        <i class="fas fa-download me-2"></i>Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        // Set current year in footer
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // DOM elements
        const fileInput = document.getElementById('file-input');
        const fileInputBtn = document.getElementById('file-input-btn');
        const dropArea = document.getElementById('drop-area');
        const fileList = document.getElementById('file-list');
        const pdfThumbnails = document.getElementById('pdf-thumbnails');
        const noFilesMessage = document.getElementById('no-files-message');
        const mergeBtn = document.getElementById('merge-btn');
        const outputFilename = document.getElementById('output-filename');
        const pageCount = document.getElementById('page-count');
        const fileCount = document.getElementById('file-count');
        const darkModeSwitch = document.getElementById('dark-mode-switch');
        const adminToggle = document.getElementById('admin-toggle');
        const adsenseConfig = document.getElementById('adsense-config');
        const saveAdsenseBtn = document.getElementById('save-adsense');
        const testAdsenseBtn = document.getElementById('test-adsense');
        const clearAllBtn = document.getElementById('clear-all');
        const publisherIdInput = document.getElementById('adsense-publisher-id');
        const unitIdInput = document.getElementById('adsense-unit-id');
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        const downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));
        const downloadBtn = document.getElementById('download-btn');
        const largePreviewCanvas = document.getElementById('large-preview-canvas');
        const pageSizeSelect = document.getElementById('page-size');

        // State variables
        let pdfFiles = [];
        let pdfPages = [];
        let isAdmin = false;
        let mergedPdfUrl = null;

        // Check for saved settings
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            darkModeSwitch.checked = true;
        }

        if (localStorage.getItem('adsensePublisherId')) {
            publisherIdInput.value = localStorage.getItem('adsensePublisherId');
        }

        if (localStorage.getItem('adsenseUnitId')) {
            unitIdInput.value = localStorage.getItem('adsenseUnitId');
        }

        // Initialize Sortable for thumbnails
        let sortable;
        
        function initSortable() {
            if (sortable) sortable.destroy();
            
            sortable = new Sortable(pdfThumbnails, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function() {
                    // Reorder pdfPages array to match new order
                    const newPdfPages = [];
                    const thumbnails = pdfThumbnails.querySelectorAll('.thumbnail-container');
                    thumbnails.forEach(thumb => {
                        const pageId = thumb.dataset.pageId;
                        const page = pdfPages.find(p => p.id === pageId);
                        if (page) newPdfPages.push(page);
                    });
                    pdfPages = newPdfPages;
                    updatePageNumbers();
                }
            });
        }

        // Event listeners
        fileInputBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('active');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('active');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('active');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        });

        mergeBtn.addEventListener('click', mergePdfs);
        darkModeSwitch.addEventListener('change', toggleDarkMode);
        adminToggle.addEventListener('click', toggleAdminMode);
        saveAdsenseBtn.addEventListener('click', saveAdsenseSettings);
        testAdsenseBtn.addEventListener('click', testAdsense);
        clearAllBtn.addEventListener('click', clearAll);
        downloadBtn.addEventListener('click', downloadMergedPdf);

        // Functions
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            const validFiles = files.filter(file => file.type === 'application/pdf' || file.name.endsWith('.pdf'));
            
            if (validFiles.length === 0) {
                alert('Please select PDF files only.');
                return;
            }
            
            pdfFiles = [...pdfFiles, ...validFiles];
            renderFileList();
            processPdfFiles(validFiles);
            fileInput.value = ''; // Reset file input
        }

        function renderFileList() {
            fileList.innerHTML = '';
            fileCount.textContent = `${pdfFiles.length} file${pdfFiles.length !== 1 ? 's' : ''}`;
            
            pdfFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <i class="fas fa-file-pdf text-danger me-2"></i>
                        <span class="file-name">${file.name}</span>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(2)} KB)</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-file" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });

            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    removeFile(index);
                });
            });
        }

        function removeFile(index) {
            // Remove the file and all its pages
            const removedFile = pdfFiles[index];
            pdfFiles.splice(index, 1);
            
            // Remove all pages from this file
            pdfPages = pdfPages.filter(page => page.fileName !== removedFile.name);
            
            renderFileList();
            renderThumbnails();
            updateCounts();
        }

        async function processPdfFiles(files) {
            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        pdfPages.push({
                            id: `${file.name}-${i}`,
                            file: arrayBuffer,
                            fileName: file.name,
                            pageNumber: i,
                            pdfPage: page,
                            rotation: 0
                        });
                    }
                    
                } catch (error) {
                    console.error('Error processing PDF:', error);
                    alert(`Error processing ${file.name}: ${error.message}`);
                }
            }
            
            renderThumbnails();
            updateCounts();
        }

        function renderThumbnails() {
            if (pdfPages.length === 0) {
                noFilesMessage.style.display = 'block';
                pdfThumbnails.style.display = 'none';
                mergeBtn.disabled = true;
                return;
            }
            
            noFilesMessage.style.display = 'none';
            pdfThumbnails.style.display = 'flex';
            pdfThumbnails.innerHTML = '';
            mergeBtn.disabled = false;
            
            pdfPages.forEach((page, index) => {
                renderThumbnail(page, index + 1);
            });
            
            initSortable();
        }

        async function renderThumbnail(page, displayNumber) {
            const viewport = page.pdfPage.getViewport({ scale: 0.2 });
            
            const thumbnailContainer = document.createElement('div');
            thumbnailContainer.className = 'thumbnail-container col-md-3 col-sm-4 col-6';
            thumbnailContainer.dataset.pageId = page.id;
            
            const canvas = document.createElement('canvas');
            canvas.className = 'thumbnail-canvas';
            canvas.dataset.pageId = page.id;
            
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.pdfPage.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            // Apply rotation if needed
            if (page.rotation !== 0) {
                applyRotation(canvas, page.rotation);
            }
            
            thumbnailContainer.innerHTML = `
                <span class="page-number">Page ${displayNumber}</span>
            `;
            thumbnailContainer.appendChild(canvas);
            
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'page-controls';
            controlsDiv.innerHTML = `
                <button class="btn btn-sm btn-outline-primary rotate-left" data-page-id="${page.id}">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="btn btn-sm btn-outline-info preview-btn" data-page-id="${page.id}">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger remove-page" data-page-id="${page.id}">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary rotate-right" data-page-id="${page.id}">
                    <i class="fas fa-redo"></i>
                </button>
            `;
            thumbnailContainer.appendChild(controlsDiv);
            
            pdfThumbnails.appendChild(thumbnailContainer);
            
            // Add event listeners
            thumbnailContainer.querySelector('.rotate-left').addEventListener('click', () => rotatePage(page.id, -90));
            thumbnailContainer.querySelector('.rotate-right').addEventListener('click', () => rotatePage(page.id, 90));
            thumbnailContainer.querySelector('.preview-btn').addEventListener('click', () => showLargePreview(page.id));
            thumbnailContainer.querySelector('.remove-page').addEventListener('click', () => removePage(page.id));
            canvas.addEventListener('click', () => showLargePreview(page.id));
        }

        function applyRotation(canvas, degrees) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            if (degrees === 90 || degrees === 270) {
                tempCanvas.width = canvas.height;
                tempCanvas.height = canvas.width;
            } else {
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
            }
            
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(degrees * Math.PI / 180);
            tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            
            // Copy back to original canvas
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(tempCanvas, 0, 0);
        }

        async function rotatePage(pageId, degrees) {
            const pageIndex = pdfPages.findIndex(p => p.id === pageId);
            if (pageIndex === -1) return;
            
            pdfPages[pageIndex].rotation = (pdfPages[pageIndex].rotation + degrees) % 360;
            if (pdfPages[pageIndex].rotation < 0) pdfPages[pageIndex].rotation += 360;
            
            // Re-render the thumbnail
            renderThumbnails();
        }

        async function showLargePreview(pageId) {
            const page = pdfPages.find(p => p.id === pageId);
            if (!page) return;
            
            const viewport = page.pdfPage.getViewport({ scale: 1.0 });
            largePreviewCanvas.height = viewport.height;
            largePreviewCanvas.width = viewport.width;
            
            await page.pdfPage.render({
                canvasContext: largePreviewCanvas.getContext('2d'),
                viewport: viewport
            }).promise;
            
            // Apply rotation if needed
            if (page.rotation !== 0) {
                applyRotation(largePreviewCanvas, page.rotation);
            }
            
            previewModal.show();
        }

        function removePage(pageId) {
            pdfPages = pdfPages.filter(p => p.id !== pageId);
            renderThumbnails();
            updateCounts();
        }

        function updateCounts() {
            fileCount.textContent = `${pdfFiles.length} file${pdfFiles.length !== 1 ? 's' : ''}`;
            pageCount.textContent = `${pdfPages.length} page${pdfPages.length !== 1 ? 's' : ''}`;
            
            // Update file list to show which files are completely removed
            const remainingFileNames = [...new Set(pdfPages.map(p => p.fileName))];
            pdfFiles = pdfFiles.filter(file => remainingFileNames.includes(file.name));
            
            if (pdfFiles.length !== remainingFileNames.length) {
                renderFileList();
            }
        }

        function updatePageNumbers() {
            const thumbnails = pdfThumbnails.querySelectorAll('.thumbnail-container');
            thumbnails.forEach((thumb, index) => {
                const pageNumber = thumb.querySelector('.page-number');
                if (pageNumber) {
                    pageNumber.textContent = `Page ${index + 1}`;
                }
            });
        }

        async function mergePdfs() {
            if (pdfPages.length === 0) {
                alert('No pages to merge!');
                return;
            }
            
            mergeBtn.disabled = true;
            mergeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Merging...';
            
            try {
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                // Set metadata
                mergedPdf.setTitle(outputFilename.value.replace('.pdf', ''));
                mergedPdf.setAuthor('PDF Merger Tool');
                
                // Set page size based on selection
                let pageSize;
                switch (pageSizeSelect.value) {
                    case 'Letter':
                        pageSize = [612, 792]; // 8.5 x 11 inches in points
                        break;
                    case 'Legal':
                        pageSize = [612, 1008]; // 8.5 x 14 inches in points
                        break;
                    case 'A4':
                    default:
                        pageSize = [595, 842]; // A4 in points
                }
                
                for (const page of pdfPages) {
                    try {
                        const pdfDoc = await PDFDocument.load(page.file);
                        const [donorPage] = await mergedPdf.copyPages(pdfDoc, [page.pageNumber - 1]);
                        
                        // Create a new page with the selected size
                        const newPage = mergedPdf.addPage(pageSize);
                        
                        // Embed the donor page and scale it to fit the new page
                        const { width, height } = donorPage.getSize();
                        const scale = Math.min(
                            newPage.getWidth() / width,
                            newPage.getHeight() / height
                        );
                        
                        // Apply rotation
                        let rotatedWidth = width;
                        let rotatedHeight = height;
                        if (page.rotation === 90 || page.rotation === 270) {
                            [rotatedWidth, rotatedHeight] = [rotatedHeight, rotatedWidth];
                        }
                        
                        newPage.drawPage(donorPage, {
                            x: (newPage.getWidth() - rotatedWidth * scale) / 2,
                            y: (newPage.getHeight() - rotatedHeight * scale) / 2,
                            width: width * scale,
                            height: height * scale,
                            rotate: page.rotation
                        });
                        
                    } catch (error) {
                        console.error(`Error merging page ${page.id}:`, error);
                        // Continue with next page even if one fails
                    }
                }
                
                const mergedPdfBytes = await mergedPdf.save();
                mergedPdfUrl = URL.createObjectURL(new Blob([mergedPdfBytes], { type: 'application/pdf' }));
                
                downloadModal.show();
                
            } catch (error) {
                console.error('Error merging PDFs:', error);
                alert(`Error merging PDFs: ${error.message}`);
            } finally {
                mergeBtn.disabled = false;
                mergeBtn.innerHTML = '<i class="fas fa-random me-2"></i>Merge PDFs';
            }
        }

        function downloadMergedPdf() {
            if (!mergedPdfUrl) return;
            
            const a = document.createElement('a');
            a.href = mergedPdfUrl;
            a.download = outputFilename.value.endsWith('.pdf') ? outputFilename.value : `${outputFilename.value}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            downloadModal.hide();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function toggleAdminMode() {
            isAdmin = !isAdmin;
            adsenseConfig.style.display = isAdmin ? 'block' : 'none';
            adminToggle.innerHTML = isAdmin 
                ? '<i class="fas fa-lock me-2"></i>Admin Mode'
                : '<i class="fas fa-unlock-alt me-2"></i>Admin Mode';
            
            if (isAdmin) {
                adminToggle.classList.add('btn-warning');
                adminToggle.classList.remove('btn-outline-secondary');
            } else {
                adminToggle.classList.remove('btn-warning');
                adminToggle.classList.add('btn-outline-secondary');
            }
        }

        function saveAdsenseSettings() {
            const publisherId = publisherIdInput.value.trim();
            const unitId = unitIdInput.value.trim();
            
            if (!publisherId || !unitId) {
                alert('Please enter both Publisher ID and Ad Unit ID');
                return;
            }
            
            localStorage.setItem('adsensePublisherId', publisherId);
            localStorage.setItem('adsenseUnitId', unitId);
            
            alert('AdSense settings saved! The ads will appear after the next page reload.');
        }

        function testAdsense() {
            const publisherId = publisherIdInput.value.trim();
            const unitId = unitIdInput.value.trim();
            
            if (!publisherId || !unitId) {
                alert('Please enter both Publisher ID and Ad Unit ID');
                return;
            }
            
            // Create test ad
            const adContainer = document.getElementById('adsense-ad');
            adContainer.innerHTML = `
                <div class="text-center p-2 border rounded bg-light">
                    <small class="text-muted">Test Ad (would use: ${publisherId}/${unitId})</small>
                    <div class="mt-2 p-2 bg-white border">
                        <p class="mb-1">Advertisement</p>
                        <p class="small text-muted mb-0">Google AdSense Ad</p>
                    </div>
                </div>
            `;
        }

        function loadAdsense() {
            const publisherId = localStorage.getItem('adsensePublisherId');
            const unitId = localStorage.getItem('adsenseUnitId');
            
            if (publisherId && unitId) {
                const adContainer = document.getElementById('adsense-ad');
                adContainer.innerHTML = `
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${publisherId}"
                        crossorigin="anonymous"></script>
                    <!-- PDF Merger Ad Unit -->
                    <ins class="adsbygoogle"
                        style="display:block"
                        data-ad-client="${publisherId}"
                        data-ad-slot="${unitId}"
                        data-ad-format="auto"
                        data-full-width-responsive="true"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                `;
            }
        }

        function clearAll() {
            if (confirm('Are you sure you want to remove all files and pages?')) {
                pdfFiles = [];
                pdfPages = [];
                renderFileList();
                renderThumbnails();
                updateCounts();
            }
        }

        // Initialize
        loadAdsense();
    </script>
</body>
</html>
