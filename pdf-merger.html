<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content remains the same] -->
    <style>
        /* [Previous CSS remains the same] */
        
        /* Add these new styles */
        .upload-error {
            color: #dc3545;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .file-uploading {
            opacity: 0.6;
            position: relative;
        }
        
        .file-uploading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.7);
        }
        
        .file-status {
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .file-success {
            color: #28a745;
        }
        
        .file-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains the same until the file list] -->
    
    <div id="file-list" class="mt-3">
        <!-- Files will appear here with status indicators -->
    </div>
    
    <div id="upload-error" class="upload-error" style="display: none;"></div>
    
    <!-- [Rest of the HTML remains the same] -->

    <script>
        // [Previous initialization code remains the same]

        // Enhanced file handling functions
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Clear previous errors
            document.getElementById('upload-error').style.display = 'none';
            
            const validFiles = files.filter(file => {
                const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                if (!isPDF) {
                    showUploadError(`File "${file.name}" is not a PDF. Only PDF files are supported.`);
                }
                return isPDF;
            });
            
            if (validFiles.length === 0) {
                showUploadError('No valid PDF files selected.');
                return;
            }
            
            // Check for duplicates
            const newFiles = validFiles.filter(newFile => 
                !pdfFiles.some(existingFile => 
                    existingFile.name === newFile.name && 
                    existingFile.size === newFile.size
                )
            );
            
            if (newFiles.length === 0) {
                showUploadError('All selected files are already added.');
                return;
            }
            
            if (newFiles.length < validFiles.length) {
                showUploadError('Some files were already added and were skipped.');
            }
            
            // Add files to queue
            pdfFiles = [...pdfFiles, ...newFiles];
            renderFileList();
            
            // Process files with individual status tracking
            processPdfFiles(newFiles);
            fileInput.value = ''; // Reset file input
        }

        function showUploadError(message) {
            const errorDiv = document.getElementById('upload-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function renderFileList() {
            fileList.innerHTML = '';
            fileCount.textContent = `${pdfFiles.length} file${pdfFiles.length !== 1 ? 's' : ''}`;
            
            pdfFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                if (file.status === 'uploading') {
                    fileItem.classList.add('file-uploading');
                }
                
                fileItem.innerHTML = `
                    <div>
                        <i class="fas fa-file-pdf text-danger me-2"></i>
                        <span class="file-name">${file.name}</span>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(2)} KB)</small>
                        ${file.status ? `<span class="file-status ${file.status === 'error' ? 'file-error' : 'file-success'}">
                            ${file.status === 'uploading' ? '<i class="fas fa-spinner fa-spin"></i> Processing...' : ''}
                            ${file.status === 'success' ? '<i class="fas fa-check"></i> Ready' : ''}
                            ${file.status === 'error' ? '<i class="fas fa-times"></i> Error' : ''}
                        </span>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-file" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });

            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    removeFile(index);
                });
            });
        }

        async function processPdfFiles(files) {
            processingModal.show();
            processingProgress.style.width = '0%';
            processingMessage.textContent = 'Preparing files...';
            
            // Initialize worker if needed
            initWorker();
            
            // Set uploading status
            files.forEach(file => {
                file.status = 'uploading';
                const index = pdfFiles.findIndex(f => f.name === file.name && f.size === file.size);
                if (index !== -1) {
                    pdfFiles[index].status = 'uploading';
                }
            });
            renderFileList();
            
            try {
                // Process files sequentially for better reliability
                for (const file of files) {
                    try {
                        processingMessage.textContent = `Processing ${file.name}...`;
                        
                        const result = await processSingleFile(file);
                        
                        // Update status
                        const fileIndex = pdfFiles.findIndex(f => f.name === file.name && f.size === file.size);
                        if (fileIndex !== -1) {
                            pdfFiles[fileIndex].status = 'success';
                        }
                        
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                        
                        // Update status
                        const fileIndex = pdfFiles.findIndex(f => f.name === file.name && f.size === file.size);
                        if (fileIndex !== -1) {
                            pdfFiles[fileIndex].status = 'error';
                            showUploadError(`Error processing ${file.name}: ${error.message}`);
                        }
                    }
                    
                    renderFileList();
                }
                
                // Final render of thumbnails
                renderThumbnails();
                updateCounts();
                
            } catch (error) {
                console.error('Error in processing queue:', error);
                showUploadError(`Processing error: ${error.message}`);
            } finally {
                processingModal.hide();
            }
        }

        async function processSingleFile(file) {
            return new Promise((resolve, reject) => {
                const fileId = `${file.name}-${file.size}-${Date.now()}`;
                
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        
                        // Verify PDF header (magic number)
                        const header = new Uint8Array(arrayBuffer.slice(0, 4));
                        const isPDF = header[0] === 0x25 && header[1] === 0x50 && 
                                      header[2] === 0x44 && header[3] === 0x46; // %PDF
                        
                        if (!isPDF) {
                            throw new Error('File does not have a valid PDF header');
                        }
                        
                        // Send to worker for processing
                        pdfWorker.postMessage({
                            file: new Blob([arrayBuffer], { type: 'application/pdf' }),
                            id: fileId
                        }, [arrayBuffer]);
                        
                        // Temporary handler for this file
                        const tempHandler = (e) => {
                            if (e.data.id === fileId) {
                                pdfWorker.removeEventListener('message', tempHandler);
                                
                                if (e.data.type === 'success') {
                                    // Add pages to our state
                                    e.data.pages.forEach((pageData, index) => {
                                        pdfPages.push({
                                            id: `${fileId}-${index}`,
                                            file: arrayBuffer,
                                            fileName: e.data.fileName,
                                            pageNumber: pageData.pageNumber,
                                            width: pageData.width,
                                            height: pageData.height,
                                            imageData: pageData.imageData,
                                            rotation: 0
                                        });
                                    });
                                    resolve();
                                } else if (e.data.type === 'error') {
                                    reject(new Error(e.data.error));
                                }
                            }
                        };
                        
                        pdfWorker.addEventListener('message', tempHandler);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('Failed to read file'));
                };
                
                reader.onabort = () => {
                    reject(new Error('File reading was aborted'));
                };
                
                // Start reading the file
                reader.readAsArrayBuffer(file);
            });
        }

        // [Rest of the JavaScript remains the same]
    </script>
</body>
</html>
